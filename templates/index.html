<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Repo Agent</title>
    <style>
        :root { --bg: #1e1e1e; --fg: #d4d4d4; --accent: #007acc; --panel: #252526; }
        body { background: var(--bg); color: var(--fg); font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--panel); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 5px; }
        .user { align-self: flex-end; background: var(--accent); color: white; }
        .bot { align-self: flex-start; background: var(--panel); border: 1px solid #333; white-space: pre-wrap; }
        
        #controls { padding: 20px; background: var(--panel); display: flex; gap: 10px; }
        input, select, textarea { background: #3c3c3c; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        textarea { flex: 1; resize: none; height: 50px; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; padding: 0 20px; }
        
        .settings-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); padding: 20px; border: 1px solid #555; z-index: 10; display: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .settings-modal input { display: block; margin-bottom: 10px; width: 250px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 5; }
    </style>
</head>
<body>

<header>
    <div>
        <span>Agent Config: </span>
        <select id="provider">
            <option value="gemini">Gemini</option>
            <option value="deepseek">DeepSeek</option>
        </select>
        <select id="model">
            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            <option value="deepseek-coder">DeepSeek Coder</option>
            <option value="deepseek-chat">DeepSeek Chat</option>
        </select>
    </div>
    <button onclick="toggleSettings()">ðŸ”‘ API Keys & Repo</button>
</header>

<div id="chat-container"></div>

<div id="controls">
    <textarea id="userInput" placeholder="Instruct file changes..."></textarea>
    <button onclick="sendMessage()">Send</button>
</div>

<div class="overlay" id="overlay"></div>
<div class="settings-modal" id="settingsModal">
    <h3>Configuration</h3>
    <input type="text" id="apiKey" placeholder="LLM API Key (Gemini/DeepSeek)">
    <input type="text" id="ghToken" placeholder="GitHub PAT (Fine-grained)">
    <input type="text" id="ghUser" placeholder="GitHub Username">
    <input type="text" id="ghRepo" placeholder="Repository Name">
    <button onclick="saveSettings()">Save to Browser Memory</button>
</div>

<script>
    // Load settings on boot
    const load = (id) => document.getElementById(id).value = localStorage.getItem(id) || '';
    ['apiKey', 'ghToken', 'ghUser', 'ghRepo'].forEach(load);

    let chatHistory = []; // Store last 10 messages here

    function toggleSettings() {
        const el = document.getElementById('settingsModal');
        const ov = document.getElementById('overlay');
        const disp = el.style.display === 'block' ? 'none' : 'block';
        el.style.display = disp;
        ov.style.display = disp;
    }

    function saveSettings() {
        ['apiKey', 'ghToken', 'ghUser', 'ghRepo'].forEach(id => {
            localStorage.setItem(id, document.getElementById(id).value);
        });
        toggleSettings();
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value;
        if (!text) return;

        addMsg('user', text);
        input.value = '';

        const payload = {
            message: text,
            history: chatHistory,
            apiKey: localStorage.getItem('apiKey'),
            ghToken: localStorage.getItem('ghToken'),
            ghUser: localStorage.getItem('ghUser'),
            ghRepo: localStorage.getItem('ghRepo'),
            provider: document.getElementById('provider').value,
            model: document.getElementById('model').value
        };

        addMsg('bot', "Thinking & Checking Repo...");

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            // Remove loading msg
            const container = document.getElementById('chat-container');
            container.removeChild(container.lastChild);

            if(data.execution_log && data.execution_log.length > 0) {
                addMsg('bot', `[System]: Executed changes:\n${data.execution_log.join('\n')}`);
            }
            addMsg('bot', data.response);

        } catch (e) {
            addMsg('bot', `Error: ${e}`);
        }
    }

    function addMsg(sender, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.innerText = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        // Update history logic
        if (sender !== 'system') {
            chatHistory.push({sender, text});
            if (chatHistory.length > 10) chatHistory.shift();
        }
    }
</script>

</body>
</html>
