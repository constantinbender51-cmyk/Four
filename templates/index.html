<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Repo Agent</title>
    <style>
        /* --- THEMING --- */
        :root {
            /* Default Dark Mode */
            --bg: #1e1e1e;
            --fg: #d4d4d4;
            --accent: #007acc;
            --panel: #252526;
            --border: #333;
            --input-bg: #3c3c3c;
            --msg-user: #007acc;
            --msg-bot: #252526;
        }

        [data-theme="light"] {
            --bg: #f0f0f0;
            --fg: #1f1f1f;
            --accent: #005a9e;
            --panel: #ffffff;
            --border: #ccc;
            --input-bg: #ffffff;
            --msg-user: #005a9e;
            --msg-bot: #e0e0e0;
        }

        /* --- BASE LAYOUT --- */
        body { 
            background: var(--bg); 
            color: var(--fg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            transition: background 0.3s, color 0.3s;
        }

        /* --- MAIN CONTENT AREA --- */
        #main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* --- FILE BROWSER --- */
        #file-browser {
            width: 280px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s;
        }

        #file-browser.hidden {
            transform: translateX(-100%);
            position: absolute;
            z-index: 3;
        }

        .browser-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .browser-header button {
            padding: 4px 8px;
            font-size: 12px;
        }

        #file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-item, .folder-item {
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
            margin: 2px 0;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            transition: background 0.15s;
        }

        .file-item:hover, .folder-item:hover {
            background: var(--input-bg);
        }

        .file-item.active {
            background: var(--accent);
            color: white;
        }

        .folder-item {
            font-weight: 500;
        }

        .folder-children {
            margin-left: 16px;
            display: none;
        }

        .folder-children.open {
            display: block;
        }

        .folder-icon {
            transition: transform 0.2s;
        }

        .folder-icon.open {
            transform: rotate(90deg);
        }

        /* --- FILE VIEWER --- */
        #file-viewer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
            z-index: 15;
            display: none;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            flex-direction: column;
        }

        .viewer-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viewer-header h3 {
            margin: 0;
            font-size: 14px;
            font-family: monospace;
        }

        .viewer-content {
            padding: 20px;
            overflow: auto;
            flex: 1;
        }

        .viewer-content pre {
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #toggle-browser {
            display: none;
        }

        /* --- HEADER --- */
        header { 
            background: var(--panel); 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* --- CHAT AREA --- */
        #chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        .msg { 
            max-width: 85%; 
            padding: 12px 16px; 
            border-radius: 8px; 
            font-family: monospace;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .user { 
            align-self: flex-end; 
            background: var(--msg-user); 
            color: white; 
        }
        
        .bot { 
            align-self: flex-start; 
            background: var(--msg-bot); 
            border: 1px solid var(--border); 
            white-space: pre-wrap; 
        }

        /* --- INPUT AREA --- */
        #controls { 
            padding: 20px; 
            background: var(--panel); 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid var(--border);
        }
        
        input, select, textarea { 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            color: var(--fg); 
            padding: 10px; 
            border-radius: 4px; 
            font-family: inherit;
        }
        
        textarea { 
            flex: 1; 
            resize: none; 
            height: 50px; 
        }
        
        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            cursor: pointer; 
            padding: 10px 20px; 
            border-radius: 4px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        
        button:hover { opacity: 0.9; }
        button.secondary { background: transparent; border: 1px solid var(--border); color: var(--fg); }

        /* --- MODAL --- */
        .settings-modal { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: var(--panel); 
            padding: 25px; 
            border: 1px solid var(--border); 
            z-index: 10; 
            display: none; 
            box-shadow: 0 4px 30px rgba(0,0,0,0.5); 
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-sizing: border-box;
        }
        
        .settings-modal h3 { margin-top: 0; }
        .settings-modal input { display: block; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 5; backdrop-filter: blur(2px); }

        /* --- MOBILE RESPONSE --- */
        @media (max-width: 768px) {
            header { flex-direction: column; align-items: stretch; }
            .header-controls { justify-content: space-between; }
            .header-controls select { flex: 1; }
            
            #controls { flex-direction: column; }
            textarea { height: 60px; }
            button { height: 44px; }
            
            .msg { max-width: 95%; }

            #file-browser {
                position: absolute;
                width: 80%;
                max-width: 300px;
                height: 100%;
                z-index: 10;
            }

            #file-browser.hidden {
                transform: translateX(-100%);
            }

            #toggle-browser {
                display: block;
                padding: 5px 10px;
            }

            #file-viewer {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; display:flex; align-items:center; gap:10px;">
        <button class="secondary" id="toggle-browser" onclick="toggleFileBrowser()" style="padding: 5px 10px;">üìÅ</button>
        <span>ü§ñ AI Agent</span>
        <button class="secondary" id="themeToggle" onclick="toggleTheme()" style="padding: 5px 10px;">üåô</button>
        <button class="secondary" id="muteToggle" onclick="toggleMute()" style="padding: 5px 10px;">üîä</button>
    </div>
    <div class="header-controls">
        <select id="provider">
            <option value="gemini">Gemini</option>
            <option value="deepseek">DeepSeek</option>
        </select>
        <select id="model">
            <option value="gemini-2.5-flash-lite">Gemini 1.5 Flash Lite</option>
            <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
            <option value="deepseek-coder">DeepSeek Coder</option>
            <option value="deepseek-chat">DeepSeek Chat</option>
        </select>
        <button onclick="toggleSettings()">‚öôÔ∏è API Keys</button>
    </div>
</header>

<div id="main-content">
    <div id="file-browser">
        <div class="browser-header">
            <span>üìÇ Files</span>
            <button onclick="loadFileTree()">üîÑ</button>
        </div>
        <div id="file-tree">
            <div style="padding: 20px; text-align: center; color: var(--border);">
                Click üîÑ to load repository files
            </div>
        </div>
    </div>

    <div id="chat-container"></div>
</div>

<div id="controls">
    <textarea id="userInput" placeholder="Instruct file changes..."></textarea>
    <button onclick="sendMessage()">Send</button>
</div>

<div class="overlay" id="overlay" onclick="toggleSettings()"></div>
<div class="settings-modal" id="settingsModal">
    <h3>Configuration</h3>
    <input type="text" id="apiKey" placeholder="LLM API Key (Gemini/DeepSeek)">
    <input type="text" id="ghToken" placeholder="GitHub PAT (Fine-grained)">
    <input type="text" id="ghUser" placeholder="GitHub Username">
    <input type="text" id="ghRepo" placeholder="Repository Name">
    <div style="display:flex; justify-content: flex-end; gap: 10px;">
        <button class="secondary" onclick="toggleSettings()">Cancel</button>
        <button onclick="saveSettings()">Save Keys</button>
    </div>
</div>

<div class="overlay" id="viewer-overlay" onclick="closeFileViewer()" style="z-index: 12;"></div>
<div id="file-viewer">
    <div class="viewer-header">
        <h3 id="viewer-filename"></h3>
        <button onclick="closeFileViewer()">‚úï</button>
    </div>
    <div class="viewer-content">
        <pre id="viewer-code"></pre>
    </div>
</div>

<script>
    // --- THEME LOGIC ---
    function initTheme() {
        const saved = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', saved);
        updateThemeIcon(saved);
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        updateThemeIcon(next);
    }

    function updateThemeIcon(theme) {
        const btn = document.getElementById('themeToggle');
        btn.innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // --- MUTE LOGIC ---
    let isMuted = localStorage.getItem('muted') === 'true';
    
    function initMute() {
        updateMuteIcon(isMuted);
    }

    function toggleMute() {
        isMuted = !isMuted;
        localStorage.setItem('muted', isMuted);
        updateMuteIcon(isMuted);
    }

    function updateMuteIcon(muted) {
        const btn = document.getElementById('muteToggle');
        btn.innerText = muted ? 'üîá' : 'üîä';
    }

    function playAudio(audioBase64) {
        if (isMuted || !audioBase64) return;
        
        try {
            const audio = new Audio('data:audio/mp3;base64,' + audioBase64);
            audio.play().catch(e => console.error('Audio playback error:', e));
        } catch (e) {
            console.error('Audio creation error:', e);
        }
    }

    // Initialize Theme and Mute
    initTheme();
    initMute();

    // --- APP LOGIC ---
    const load = (id) => document.getElementById(id).value = localStorage.getItem(id) || '';
    ['apiKey', 'ghToken', 'ghUser', 'ghRepo'].forEach(load);

    let chatHistory = [];
    let heartbeatInterval = null;

    // Keep-alive heartbeat
    function startHeartbeat() {
        if (heartbeatInterval) return;
        heartbeatInterval = setInterval(async () => {
            try {
                await fetch('/api/heartbeat');
            } catch (e) {
                console.log('Heartbeat failed:', e);
            }
        }, 30000);
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    }

    startHeartbeat();

    function toggleSettings() {
        const el = document.getElementById('settingsModal');
        const ov = document.getElementById('overlay');
        const disp = el.style.display === 'block' ? 'none' : 'block';
        el.style.display = disp;
        ov.style.display = disp;
    }

    function saveSettings() {
        ['apiKey', 'ghToken', 'ghUser', 'ghRepo'].forEach(id => {
            localStorage.setItem(id, document.getElementById(id).value);
        });
        toggleSettings();
        if (localStorage.getItem('ghToken') && localStorage.getItem('ghUser') && localStorage.getItem('ghRepo')) {
            loadFileTree();
        }
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value;
        if (!text) return;

        addMsg('user', text);
        input.value = '';

        const payload = {
            message: text,
            history: chatHistory,
            apiKey: localStorage.getItem('apiKey'),
            ghToken: localStorage.getItem('ghToken'),
            ghUser: localStorage.getItem('ghUser'),
            ghRepo: localStorage.getItem('ghRepo'),
            provider: document.getElementById('provider').value,
            model: document.getElementById('model').value
        };

        addMsg('bot', "Thinking & Checking Repo...");

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000);

        let retries = 3;
        let success = false;

        while (retries > 0 && !success) {
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Connection': 'keep-alive'
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal,
                    keepalive: true
                });
                
                clearTimeout(timeoutId);

                const data = await res.json();
                
                const container = document.getElementById('chat-container');
                container.removeChild(container.lastChild);

                if(data.execution_log && data.execution_log.length > 0) {
                    addMsg('bot', `[System]: Executed changes:\n${data.execution_log.join('\n')}`);
                }
                addMsg('bot', data.response);
                
                if (data.audio) {
                    playAudio(data.audio);
                }

                success = true;

            } catch (e) {
                retries--;
                
                if (retries === 0) {
                    const container = document.getElementById('chat-container');
                    if (e.name === 'AbortError') {
                        addMsg('bot', `Error: Request timed out after 5 minutes.`);
                    } else {
                        addMsg('bot', `Error: ${e.message || e}`);
                    }
                } else {
                    console.log(`Retry attempt ${4 - retries}/3...`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
    }

    function addMsg(sender, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.innerText = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        if (sender !== 'system') {
            chatHistory.push({sender, text});
            if (chatHistory.length > 10) chatHistory.shift();
        }
    }

    // --- FILE BROWSER LOGIC ---
    let fileTreeData = [];

    function toggleFileBrowser() {
        const browser = document.getElementById('file-browser');
        browser.classList.toggle('hidden');
    }

    async function loadFileTree() {
        const ghToken = localStorage.getItem('ghToken');
        const ghUser = localStorage.getItem('ghUser');
        const ghRepo = localStorage.getItem('ghRepo');

        if (!ghToken || !ghUser || !ghRepo) {
            document.getElementById('file-tree').innerHTML = 
                '<div style="padding: 20px; text-align: center; color: var(--border);">Configure API Keys first</div>';
            return;
        }

        document.getElementById('file-tree').innerHTML = 
            '<div style="padding: 20px; text-align: center;">Loading...</div>';

        try {
            const response = await fetch('/api/files', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ghToken, ghUser, ghRepo })
            });

            const data = await response.json();
            
            if (data.error) {
                document.getElementById('file-tree').innerHTML = 
                    `<div style="padding: 20px; color: #ff6b6b;">${data.error}</div>`;
                return;
            }

            fileTreeData = data.files;
            renderFileTree();
        } catch (e) {
            document.getElementById('file-tree').innerHTML = 
                `<div style="padding: 20px; color: #ff6b6b;">Error: ${e.message}</div>`;
        }
    }

    function renderFileTree() {
        const tree = buildTree(fileTreeData);
        document.getElementById('file-tree').innerHTML = renderTree(tree);
    }

    function buildTree(files) {
        const root = {};
        
        files.forEach(file => {
            const parts = file.path.split('/');
            let current = root;
            
            parts.forEach((part, idx) => {
                if (!current[part]) {
                    current[part] = idx === parts.length - 1 ? null : {};
                }
                if (current[part] !== null) {
                    current = current[part];
                }
            });
        });
        
        return root;
    }

    function renderTree(tree, path = '') {
        let html = '';
        const entries = Object.keys(tree).sort((a, b) => {
            const aIsFile = tree[a] === null;
            const bIsFile = tree[b] === null;
            if (aIsFile === bIsFile) return a.localeCompare(b);
            return aIsFile ? 1 : -1;
        });

        entries.forEach(name => {
            const fullPath = path ? `${path}/${name}` : name;
            const isFile = tree[name] === null;

            if (isFile) {
                html += `<div class="file-item" onclick="openFile(event, '${fullPath}')">
                    üìÑ ${name}
                </div>`;
            } else {
                const folderId = fullPath.replace(/[^a-zA-Z0-9]/g, '_');
                html += `<div>
                    <div class="folder-item" onclick="toggleFolder('${folderId}')">
                        <span class="folder-icon" id="icon-${folderId}">‚ñ∂</span>
                        üìÅ ${name}
                    </div>
                    <div class="folder-children" id="folder-${folderId}">
                        ${renderTree(tree[name], fullPath)}
                    </div>
                </div>`;
            }
        });

        return html;
    }

    function toggleFolder(folderId) {
        const folder = document.getElementById(`folder-${folderId}`);
        const icon = document.getElementById(`icon-${folderId}`);
        
        folder.classList.toggle('open');
        icon.classList.toggle('open');
    }

    async function openFile(event, filepath) {
        const ghToken = localStorage.getItem('ghToken');
        const ghUser = localStorage.getItem('ghUser');
        const ghRepo = localStorage.getItem('ghRepo');

        document.getElementById('viewer-filename').textContent = filepath;
        document.getElementById('viewer-code').textContent = 'Loading...';
        document.getElementById('file-viewer').style.display = 'flex';
        document.getElementById('viewer-overlay').style.display = 'block';

        try {
            const response = await fetch('/api/file-content', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ghToken, ghUser, ghRepo, filepath })
            });

            const data = await response.json();
            
            if (data.error) {
                document.getElementById('viewer-code').textContent = `Error: ${data.error}`;
            } else {
                document.getElementById('viewer-code').textContent = data.content;
            }

            // Highlight active file
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
        } catch (e) {
            document.getElementById('viewer-code').textContent = `Error: ${e.message}`;
        }
    }

    function closeFileViewer() {
        document.getElementById('file-viewer').style.display = 'none';
        document.getElementById('viewer-overlay').style.display = 'none';
    }

    window.addEventListener('load', () => {
        if (localStorage.getItem('ghToken') && localStorage.getItem('ghUser') && localStorage.getItem('ghRepo')) {
            loadFileTree();
        }
    });
</script>

</body>
</html>
